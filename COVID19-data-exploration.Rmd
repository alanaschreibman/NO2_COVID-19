---
title: "COVID-19 Outcomes"
author: "Alana Schreibman"
date: "5/27/2021"
output: 
  html_document:
    toc: true
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: cosmo
    highlight: pygments
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

***

The purpose of this file is to practice applying basic R commands learned through lecture videos and perform exploratory analysis on worldwide COVID-19 data. 

```{r, eval = TRUE}
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(cowplot)
```

### Our World in Data GitHub COVID-19 outcomes
Data was read in and summarized as shown below: (current file is as of 5/31)
```{r, eval = TRUE}
owid <- read.csv(url("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv"), na.strings = c("", "NA"), colClasses = c("date" = "Date"), header = TRUE)
dim(owid)
```


```{r, eval = FALSE}
head(owid)
str(owid)
summary(owid)
```

#### Full Cleaned Data Set
Data set, including possible confounders for use in later analysis, is cleaned and filtered below. 
```{r, eval = TRUE}
owid.filtered <- owid %>%
                  rename(iso.code = iso_code, totcases = total_cases, totdeaths = total_deaths, totcases.mil = total_cases_per_million, totdeaths.mil = total_deaths_per_million, pop.density = population_density, med.age = median_age, older70 = aged_70_older, gdp.cap = gdp_per_capita, card.death = cardiovasc_death_rate, diab.prev = diabetes_prevalence, fem.smokers = female_smokers, male.smokers = male_smokers) %>%
                  select(c(iso.code:totcases, totdeaths, totcases.mil, totdeaths.mil, population, pop.density, med.age, older70, gdp.cap, card.death, diab.prev, fem.smokers, male.smokers)) %>% #Renamed variables and filtered to keep only those of interest. 
                  filter(date == "2020-05-31") #Filtered out all but most recent date (most recent date is a running sum of total cases).
table(owid.filtered$continent, useNA = "ifany") #Data includes both continent and country-specific outcomes. Continent outcomes can be distinguished by "NA" in the continent column; the continent name is in the location column. 
```

More exploratory analysis of data frames:
```{r, eval = FALSE}
dim(owid.filtered)
head(owid.filtered)
tail(owid.filtered)
```

#### Continent Analysis
Data is filtered to remove entries for specific country locations and include only data that aggregates COVID-19 outcomes on a continent and world scale. 
```{r, eval = TRUE}
owid.continents <- owid.filtered %>%
                    filter(is.na(continent)) %>%
                    select(-continent) #Used missingness properties to select only continent rows and then removed continent column. 
table(owid.continents$location)
```

#### Country Analysis
Data is filtered to include only country-specific COVID-19 outcomes and exclude continent and world-wide data.  
```{r, eval = TRUE}
owid.countries <- owid.filtered %>%
                    filter(!is.na(continent)) #Removed all rows with NA for continent, leaving behind only countries. 
table(owid.countries$continent)
```

#### Tests for Missingness
```{r, eval = TRUE}
table(owid.filtered$totcases, useNA = "ifany") %>%
  tail() #No missing values for total cases column. 
table(owid.filtered$totdeaths, useNA = "ifany") %>%
  tail() #Several missing values for total deaths column. Keep this in mind when analyzing. 
which(is.na(owid.filtered$totdeaths))
#Missing countries: Butan, Cambodia, Dominica, Eritrea, Fiji, Grenada, Laos, Lesotho, Mongolia, Namibia, Saint Kitts and Nevis, Saint Lucia, Saint Vincent and the Grenadines, Seychelles, Timor, Uganda, Vatican, Vietnam.

#Missingness for confounders: 
owid.countries[!complete.cases(owid.countries), ] #Most missingness in smoking categories. 
```

#### Modified Data Frames
Filtered OWID data frames further narrowed to COVID-19 cases only, deaths only, and hospitalizations only, separated by continent and by country respectively. 
```{r, eval = FALSE}
#By continent:
select(owid.continents, c(iso.code:totcases, totcases.mil)) #COVID-19 cases by continent. 
select(owid.continents, c(iso.code:date, totdeaths, totdeaths.mil)) #COVID-19 deaths by continent. 
select(owid.continents, c(iso.code:date, hosp.patients, hosp.patients.mil)) #COVID-19 hospitalizations by continent. 

#By country:
select(owid.countries, c(iso.code:totcases, totcases.mil)) #COVID-19 cases by country. 
select(owid.countries, c(iso.code:date, totdeaths, totdeaths.mil)) #COVID-19 deaths by country. 
select(owid.countries, c(iso.code:date, hosp.patients, hosp.patients.mil)) #COVID-19 hospitalizations by country.  
```

## Case Count Plots
### Continent COVID-19 Plots
Plots for exploratory analysis comparing COVID-19 cases by continent for total cases, total cases per million people, total deaths, and total deaths per million people.
```{r, eval = TRUE}
continents1 <- owid.continents %>%
                  filter(!(location %in% c("International", "World"))) %>%
                  ggplot(aes(x = location, y = totcases)) +
                  geom_bar(stat="identity") +
                  geom_text(aes(label = totcases), vjust = -0.25, size = 3) + 
                  labs(title = "Total COVID-19 Cases by Continent") +
                  labs(x = "Continent", y = "Total COVID-19 Cases") +
                  theme(axis.text.x = element_text(angle = 45, hjust = 1)) #Barplot of total cases by continent. 

continents2 <- owid.continents %>%
                  filter(!(location %in% c("International", "World"))) %>%
                  ggplot(aes(x = location, y = totcases.mil)) +
                  geom_bar(stat="identity") + 
                  geom_text(aes(label = totcases.mil), vjust = -0.25, size = 3) + 
                  labs(title = "Total COVID-19 Cases per Million People by Continent") +
                  labs(x = "Continent", y = "Total COVID-19 Cases per Million") +
                  theme(axis.text.x = element_text(angle = 45, hjust = 1)) #Barplot of total cases per million by continent.

plot_grid(continents1, continents2, labels = "AUTO")

continents3 <- owid.continents %>%
                    filter(!(location %in% c("International", "World"))) %>%
                    ggplot(aes(x = location, y = totdeaths)) +
                    geom_bar(stat="identity") +
                    geom_text(aes(label = totdeaths), vjust = -0.25, size = 3) + 
                    labs(title = "Total COVID-19 Deaths by Continent") +
                    labs(x = "Continent", y = "Total COVID-19 Cases") +
                    theme(axis.text.x = element_text(angle = 45, hjust = 1)) #Barplot of total deaths by continent. 

continents4 <- owid.continents %>%
                    filter(!(location %in% c("International", "World"))) %>%
                    ggplot(aes(x = location, y = totdeaths.mil)) +
                    geom_bar(stat="identity") +
                    geom_text(aes(label = totdeaths.mil), vjust = -0.25, size = 3) + 
                    labs(title = "Total COVID-19 Death per Million by Continent") +
                    labs(x = "Continent", y = "Total COVID-19 Cases") +
                    theme(axis.text.x = element_text(angle = 45, hjust = 1)) #Barplot of total deaths per million by continent.

plot_grid(continents3, continents4, labels = "AUTO")
```

### Top 10 Country COVID-19 Plots
Barplots filtering out the 10 countries with the highest COVID-19 cases per million people on each continent, as well as a heatmap of all countries, are the outputs of the code below: 
```{r, eval = TRUE}
ctry.mean.cases <- owid.countries %>%
    group_by(continent) %>%
    summarise(totcases.mil = mean(totcases.mil, na.rm = TRUE)) #Mean COVID-19 cases per country, grouped by continent.
mean.cases <- function(x) {
                      ctry.mean.cases %>%
                      filter(continent == x) %>%
                      select(totcases.mil) %>%
                      as.numeric()
} #Function to produce numeric value of mean COVID-19 cases per country by continent to be used in bar graphs below. 
top.ctry.cases <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    arrange(desc(totcases.mil)) %>%
                    head(n=10) %>%
                    ggplot(aes(x = location, y = totcases.mil)) +
                        geom_bar(stat = "identity") +
                        geom_abline(slope=0, intercept= mean.cases(x),  col = "red", lty=2) +
                        labs(x = "Country", y = "Total COVID-19 Cases per Million People") +
                        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x)))
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(top.ctry.cases(i))
} #Loops function for continents of interest. 

ctry.mean.deaths <- owid.countries %>%
    group_by(continent) %>%
    summarise(totdeaths.mil = mean(totdeaths.mil, na.rm = TRUE)) #Mean COVID-19 daeths per country, grouped by continent.
mean.deaths <- function(x) {
                      ctry.mean.deaths %>%
                      filter(continent == x) %>%
                      select(totdeaths.mil) %>%
                      as.numeric()
} #Function to produce numeric value of mean COVID-19 deaths per country by continent to be used in bar graphs below. 
top.ctry.deaths <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    arrange(desc(totdeaths.mil)) %>%
                    head(n=10) %>%
                    ggplot(aes(x = location, y = totdeaths.mil)) +
                        geom_bar(stat = "identity") +
                        geom_abline(slope=0, intercept= mean.deaths(x),  col = "red", lty=2) +
                        labs(x = "Country", y = "Total COVID-19 Deaths per Million People") +
                        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x)))
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(top.ctry.deaths(i))
} #Loops function for continents of interest. 
```

### Heatmaps of COVID-19 Cases Over Time, All Countries
```{r, eval = TRUE, fig.width = 25, fig.height = 35}
owid %>%
  rename(iso.code = iso_code, totcases.mil = total_cases_per_million) %>%
  select(c(iso.code:date, totcases.mil)) %>%
  filter(!is.na(continent)) %>%
  ggplot(aes(x = date, y = location, fill = totcases.mil)) +
    geom_tile() +
    labs(title = "Total COVID-19 Cases per Million Over Time", size = 22) +
    scale_x_date(date_breaks = "1 month") +
    scale_fill_gradient(low = "#ffeda0", high = "#f03b20") +
    ggsave(file = "test.image.pdf", width = 20, height = 25) #Total cases per million over time by country as heatmap. 

owid %>%
  rename(iso.code = iso_code, new.cases = new_cases) %>%
  select(c(iso.code:date, new.cases)) %>%
  filter(!is.na(continent)) %>%
  ggplot(aes(x = date, y = location, fill = new.cases)) +
    geom_tile() +
    labs(title = "New COVID-19 Cases per Million Over Time", size = 22) +
    scale_x_date(date_breaks = "1 month") +
    scale_fill_gradient(low = "#ffeda0", high = "#f03b20", limits = c(0, 20000)) +
    ggsave(file = "test.image2.pdf", width = 20, height = 25) #New cases per million over time by country as heatmap. Difficult to scale because range is so large.  
```

## Population Size and COVID-19 Outcomes
### Population Size and COVID-19 Cases per Million
Population size and population density are evaluated below as confounding variables for COVID-19 cases. These variables are first analyzed on a full-world scale, and then by continent. 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = population, y = totcases.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Population Size", y = "Total COVID-19 Cases per Million People") +
  labs(title = ("World COVID-19 Cases per Million People vs. Population Size")) #COVID-19 cases and population size on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totcases.mil, owid.countries$population, use = "complete.obs") 
pop.lm.cases <- lm(totcases.mil ~ population, data = owid.countries)
pop.lm.cases
summary.lm(pop.lm.cases) #Summary statistics for linear fit. Not a significant relationship. 

ggplot(data = owid.countries, aes(x = pop.density, y = totcases.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Population Density", y = "Total COVID-19 Cases per Million People") +
  labs(title = ("World COVID-19 Cases per Million People vs. Population Density")) #COVID-19 cases and population size on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totcases.mil, owid.countries$pop.density, use = "complete.obs") 
pop.den.lm.cases <- lm(totcases.mil ~ pop.density, data = owid.countries)
pop.den.lm.cases
summary.lm(pop.den.lm.cases) #Summary statistics for linear fit. Not a significant relationship. 

cases.pop <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = population, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Population Size", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. Population Size"))
} 
pop.lm.cases.cont <- function(x) {
                        owid.countries %>%
                        filter(continent == x) %>%
                        lm(totcases.mil ~ population,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
   print(cases.pop(i)) 
   print(pop.lm.cases.cont(i)) 
} #Loops function for continents of interest. 

cases.pop.den <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = pop.density, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Population Density", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. Population Density"))
} 
pop.den.lm.cases.cont <- function(x) {
                        owid.countries %>%
                        filter(continent == x) %>%
                        lm(totcases.mil ~ pop.density,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(cases.pop.den(i))
  print(pop.den.lm.cases.cont(i))
} #Loops function for continents of interest. 
```

### Population Size and COVID-19 Deaths per Million
Population size and population density are evaluated below as confounding variables for COVID-19 deaths. These variables are first analyzed on a full-world scale, and then by continent. 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = population, y = totdeaths.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Population Size", y = "Total COVID-19 Deaths per Million People") +
  labs(title = ("World COVID-19 Deaths per Million People vs. Population Size")) #COVID-19 deaths and population size on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totdeaths.mil, owid.countries$population, use = "complete.obs") 
pop.lm.deaths <- lm(totdeaths.mil ~ population, data = owid.countries)
pop.lm.deaths
summary.lm(pop.lm.deaths) #Summary statistics for linear fit. Not a significant relationship. 

ggplot(data = owid.countries, aes(x = pop.density, y = totdeaths.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Population Density", y = "Total COVID-19 Deaths per Million People") +
  labs(title = ("World COVID-19 Deaths per Million People vs. Population Density")) #COVID-19 deaths and population size on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totdeaths.mil, owid.countries$pop.density, use = "complete.obs") 
pop.den.lm.deaths <- lm(totdeaths.mil ~ pop.density, data = owid.countries)
pop.den.lm.deaths
summary.lm(pop.den.lm.deaths) #Summary statistics for linear fit. Not a significant relationship. 

deaths.pop <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = population, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Population Size", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. Population Size"))
} 
pop.lm.deaths.cont <- function(x) {
                        owid.countries %>%
                        filter(continent == x) %>%
                        lm(totdeaths.mil ~ population,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.pop(i))
  print(pop.lm.deaths.cont(i))
} #Loops function for continents of interest. 

deaths.pop.den <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = pop.density, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Population Density", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. Population Density"))
} 
pop.den.lm.cases.cont <- function(x) {
                        owid.countries %>%
                        filter(continent == x) %>%
                        lm(totdeaths.mil ~ pop.density,.) %>%
                        summary.lm() #Function for linear regression statistics to be included in for loop below. 
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.pop.den(i))
  print(pop.den.lm.cases.cont(i))
} #Loops function for continents of interest.
```

## GDP and COVID-19 Outcomes
### GDP and COVID-19 Cases per Million
First, a linear regression is performed on world COVID-19 cases and GDP. Then, scatter plots with a smooth line showing the relationship between GDP per capita and COVID-19 cases per million people are the outputs of the function below: 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = gdp.cap, y = totcases.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "GDP per Capita", y = "Total COVID-19 Cases per Million People") +
  labs(title = paste0("World COVID-19 Cases per Million People in vs. GDP per Capita")) #COVID-19 cases and GDP per capita on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totcases.mil, owid.countries$gdp.cap, use = "complete.obs") 
gdp.lm.cases <- lm(totcases.mil ~ gdp.cap, data = owid.countries)
gdp.lm.cases
summary.lm(gdp.lm.cases) #Summary statistics for linear fit. 

cases.gdp <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = gdp.cap, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "GDP per Capita", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. GDP per Capita"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(cases.gdp(i))
} #Loops function for continents of interest. 
```

### GDP and COVID-19 Deaths per Million
First, a linear regression is performed on world COVID-19 deaths and GDP. Scatter plots with a smooth line showing the relationship between GDP per capita and COVID-19 deaths per million people are the outputs of the function below: 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = gdp.cap, y = totdeaths.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "GDP per Capita", y = "Total COVID-19 Deaths per Million People") +
  labs(title = paste0("World COVID-19 Deaths per Million People in vs. GDP per Capita")) #COVID-19 deaths and GDP per capita on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totdeaths.mil, owid.countries$gdp.cap, use = "complete.obs") 
gdp.lm.deaths <- lm(totdeaths.mil ~ gdp.cap, data = owid.countries)
gdp.lm.deaths
summary.lm(gdp.lm.deaths) #Summary statistics for linear fit. 

deaths.gdp <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = gdp.cap, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "GDP per Capita", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. GDP per Capita"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.gdp(i))
} #Loops function for continents of interest. 
```

## Median Age and COVID-19 Outcomes
### Median Age and COVID-19 Cases per Million
First, scatter plot shows all countries and the relationship between median age and COVID-19 outcomes. Next, median age is cut in two halves and converted to factors with labels "below.med" and "above.med". A bar plot shows COVID-19 cases per million for each country separated by continent, with fill color indicating whether the median population age is above or below the global median. 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = med.age, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Median Age", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. Median Population Age") #COVID-19 cases vs. median age on world scale. 
cor(owid.countries$totcases.mil, owid.countries$med.age, use = "complete.obs")
age.lm.cases <- lm(totcases.mil ~ med.age, data = owid.countries)
age.lm.cases
summary.lm(age.lm.cases) #Summary statistics for linear fit. 

exp.model.cases <- lm(log(totcases.mil) ~ med.age, data = owid.countries)
exp.model.cases
summary.lm(exp.model.cases)

summarise(owid.countries, med.age = mean(med.age, na.rm = TRUE)) #Mean of the median age of all countries.
cases.med.age <- function(x) { 
                    owid.countries %>%
                    mutate(med.age = cut(med.age, breaks = c(0, 30.38, 48.3), labels = c("below.med", "above.med"))) %>%
                    mutate(med.age <- as.factor(med.age)) %>%
                    filter(continent == x) %>%
                    ggplot(aes(x = location, y = totcases.mil, fill = factor(med.age))) +
                        geom_bar(stat = "identity", position = "dodge") +
                        theme_bw() +
                        labs(x = "Country", y = "Total COVID-19 Cases per Million People") +
                        scale_fill_brewer(palette = "Set1") +
                        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
                        labs(title = paste0("COVID-19 Cases per Million People by Country in ", (continent = x), " and Median Age"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(cases.med.age(i))
} #Loops function for continents of interest.
```

### Median Age and COVID-19 Deaths per Million
First, scatter plot shows all countries and the relationship between median age and COVID-19 deaths. Next, median age is cut in two halves and converted to factors with labels "below.med" and "above.med". A bar plot shows COVID-19 daeths per million for each country separated by continent, with fill color indicating whether the median population age is above or below the global median. 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = med.age, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Median Age", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. Median Population Age") #COVID-19 deaths vs. median age on world scale. 
cor(owid.countries$totdeaths.mil, owid.countries$med.age, use = "complete.obs")
age.lm.deaths <- lm(totdeaths.mil ~ med.age, data = owid.countries)
age.lm.deaths
summary.lm(age.lm.deaths) #Summary statistics for linear fit. 

exp.model.deaths <- lm(log(totdeaths.mil) ~ med.age, data = owid.countries)
exp.model.deaths
summary.lm(exp.model.deaths)

summarise(owid.countries, med.age = mean(med.age, na.rm = TRUE)) #Mean of the median age of all countries.
deaths.med.age <- function(x) { 
                    owid.countries %>%
                    mutate(med.age = cut(med.age, breaks = c(0, 30.38, 48.3), labels = c("below.med", "above.med"))) %>%
                    mutate(med.age <- as.factor(med.age)) %>%
                    filter(continent == x) %>%
                    ggplot(aes(x = location, y = totdeaths.mil, fill = factor(med.age))) +
                        geom_bar(stat = "identity", position = "dodge") +
                        theme_bw() +
                        labs(x = "Country", y = "Total COVID-19 Deaths per Million People") +
                        scale_fill_brewer(palette = "Set1") +
                        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
                        labs(title = paste0("COVID-19 Deaths per Million People by Country in ", (continent = x), " and Median Age"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.med.age(i))
} #Loops function for continents of interest.
```

## Smoking and COVID-19 Outcomes
### Smoking and COVID-19 Cases per Million 
Graphs below show percentages of female and male smokers by country and the correlation to COVID-19 cases. 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = fem.smokers, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "Percentage of Female Smokers by Country", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. Percentage of Female Smokers") #COVID-19 cases vs. female smokers on world scale. 
cor(owid.countries$totcases.mil, owid.countries$fem.smokers, use = "complete.obs") 

ggplot(data = owid.countries, aes(x = male.smokers, y = totcases.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "Percentage of Male Smokers by Country", y = "Total COVID-19 Cases per Million People") +
  labs(title = "World COVID-19 Cases per Million People vs. Percentage of Male Smokers") #COVID-19 cases vs. male smokers on world scale. 
cor(owid.countries$totcases.mil, owid.countries$male.smokers, use = "complete.obs") 

cases.smoking.f <- function(x) {
                    owid.countries %>%
                    filter(continent == x) %>%
                    ggplot(aes(x = fem.smokers, y = totcases.mil)) +
                      geom_point(color = "#333aff", alpha = 1) +
                      geom_smooth(color = "red") +
                      theme_bw() +
                      labs(x = "Percentage of Female Smokers in Country", y = "Total COVID-19 Cases per Million People") +
                      labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. Percentage of Female Smokers"))
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(cases.smoking.f(i)) #Apply function to each continent. 
}

cases.smoking.m <- function(x) {
                    owid.countries %>%
                    filter(continent == x) %>%
                    ggplot(aes(x = male.smokers, y = totcases.mil)) +
                      geom_point(color = "#333aff", alpha = 1) +
                      geom_smooth(color = "red") +
                      theme_bw() +
                      labs(x = "Percentage of Male Smokers in Country", y = "Total COVID-19 Cases per Million People") +
                      labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. Percentage of Male Smokers"))
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(cases.smoking.m(i)) #Apply function to each continent. 
}
```

### Smoking and COVID-19 Deaths per Million 
Graphs below show percentages of female and male smokers in the world and by country and the correlation to COVID-19 deaths. 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = fem.smokers, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "Percentage of Female Smokers by Country", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. Percentage of Female Smokers") #COVID-19 deaths vs. female smokers on world scale. 
cor(owid.countries$totdeaths.mil, owid.countries$fem.smokers, use = "complete.obs") 

ggplot(data = owid.countries, aes(x = male.smokers, y = totdeaths.mil)) +
  geom_point(color = "#333aff", alpha = 1) +
  geom_smooth(color = "red") +
  theme_bw() +
  labs(x = "Percentage of Male Smokers by Country", y = "Total COVID-19 Deaths per Million People") +
  labs(title = "World COVID-19 Deaths per Million People vs. Percentage of Male Smokers") #COVID-19 deaths vs. male smokers on world scale. 
cor(owid.countries$totdeaths.mil, owid.countries$male.smokers, use = "complete.obs") 

deaths.smoking.f <- function(x) {
                    owid.countries %>%
                    filter(continent == x) %>%
                    ggplot(aes(x = fem.smokers, y = totdeaths.mil)) +
                      geom_point(color = "#333aff", alpha = 1) +
                      geom_smooth(color = "red") +
                      theme_bw() +
                      labs(x = "Percentage of Female Smokers in Country", y = "Total COVID-19 Deaths per Million People") +
                      labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. Percentage of Female Smokers"))
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.smoking.f(i)) #Apply function to each continent. 
}

deaths.smoking.m <- function(x) {
                    owid.countries %>%
                    filter(continent == x) %>%
                    ggplot(aes(x = male.smokers, y = totdeaths.mil)) +
                      geom_point(color = "#333aff", alpha = 1) +
                      geom_smooth(color = "red") +
                      theme_bw() +
                      labs(x = "Percentage of Male Smokers in Country", y = "Total COVID-19 Deaths per Million People") +
                      labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. Percentage of Male Smokers"))
}
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.smoking.m(i)) #Apply function to each continent. 
}

#Smoking likely not significant: when adjusting for GDP, statistical significance actually goes down. Same occurs when applied code to total deaths (code not shown).
summary(lm(totcases.mil ~ fem.smokers + gdp.cap, data = owid.countries)) #Female smokers with and without ajdusting for GDP. 
summary(lm(totcases.mil ~ fem.smokers, data = owid.countries))
summary(lm(totcases.mil ~ male.smokers + gdp.cap, data = owid.countries)) #Male smokers with and without adjusting for GDP. 
summary(lm(totcases.mil ~ male.smokers, data = owid.countries))
```

## Diabetes Prevalence and COVID-19 Outcomes
### Diabetes Prevalence and COVID-19 Cases per Million
First, a linear regression is performed on world COVID-19 cases and diabetes prevalence. Then, scatter plots with a smooth line showing the relationship of diabetes prevalence and COVID-19 cases per million people are the outputs of the function below: 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = diab.prev, y = totcases.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Diabetes Prevalence", y = "Total COVID-19 Cases per Million People") +
  labs(title = paste0("World COVID-19 Cases per Million People in vs. Diabetes Prevalence")) #COVID-19 cases and diabetes prevalence on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totcases.mil, owid.countries$diab.prev, use = "complete.obs") 
diab.lm.cases <- lm(totcases.mil ~ diab.prev, data = owid.countries)
diab.lm.cases
summary.lm(diab.lm.cases) #Summary statistics for linear fit. 

cases.diab <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = diab.prev, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Diabetes Prevalence", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. Diabetes Prevalence"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(cases.diab(i))
} #Loops function for continents of interest. 
```

### Diabetes Prevalence and COVID-19 Deaths per Million
First, a linear regression is performed on world COVID-19 deaths and diabetes prevalence. Scatter plots with a smooth line showing the relationship of diabetes prevalence and COVID-19 deaths per million people are the outputs of the function below: 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = diab.prev, y = totdeaths.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Diabetes Prevalence", y = "Total COVID-19 Deaths per Million People") +
  labs(title = paste0("World COVID-19 Deaths per Million People in vs. Diabetes Prevalence")) #COVID-19 deaths and diabetes prevalence on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totdeaths.mil, owid.countries$diab.prev, use = "complete.obs") 
diab.lm.deaths <- lm(totdeaths.mil ~ diab.prev, data = owid.countries)
diab.lm.deaths
summary.lm(diab.lm.deaths) #Summary statistics for linear fit. 

deaths.diab <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = diab.prev, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Diabetes Prevalence", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. Diabetes Prevalence"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.diab(i))
} #Loops function for continents of interest. 
```

## Cardiovascular Death and COVID-19 Outcomes
### Cardiovascular Death and COVID-19 Cases per Million
First, a linear regression is performed on world COVID-19 cases and cardiovascular death. Then, scatter plots with a smooth line showing the relationship between cardiovascular death and COVID-19 cases per million people are the outputs of the function below: 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = card.death, y = totcases.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Cardiovascular Death", y = "Total COVID-19 Cases per Million People") +
  labs(title = paste0("World COVID-19 Cases per Million People in vs. Cardiovascular Death")) #COVID-19 cases and cardiovascular death on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totcases.mil, owid.countries$card.death, use = "complete.obs") 
card.lm.cases <- lm(totcases.mil ~ card.death, data = owid.countries)
card.lm.cases
summary.lm(card.lm.cases) #Summary statistics for linear fit. 

cases.card <- function(x) { 
                  owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = card.death, y = totcases.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Cardiovascular Death", y = "Total COVID-19 Cases per Million People") +
                        labs(title = paste0("COVID-19 Cases per Million People in ", (continent = x), " vs. Cardiovascular Death"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(cases.card(i))
} #Loops function for continents of interest. 
```

### Cardiovascular Death and COVID-19 Deaths per Million
First, a linear regression is performed on world COVID-19 deaths and cardiovascular death rates from 2017. Scatter plots with a smooth line showing the relationship between cardiovascular death rates and COVID-19 deaths per million people are the outputs of the function below: 
```{r, eval = TRUE}
ggplot(data = owid.countries, aes(x = card.death, y = totdeaths.mil)) +
  geom_point(color = "#333aff") +
  geom_smooth(color = "red") +
  geom_smooth(method = "lm", color = "purple") +
  theme_bw() +
  labs(x = "Cardiovascular Death", y = "Total COVID-19 Deaths per Million People") +
  labs(title = paste0("World COVID-19 Deaths per Million People in vs. Cardiovascular Death")) #COVID-19 deaths and cardiovascular death on world scale. Red line is smooth fit; purple line is linear fit. 
cor(owid.countries$totdeaths.mil, owid.countries$card.death, use = "complete.obs") 
card.lm.deaths <- lm(totdeaths.mil ~ card.death, data = owid.countries)
card.lm.deaths
summary.lm(card.lm.deaths) #Summary statistics for linear fit. 

deaths.card <- function(x) { 
                    owid.countries %>% 
                    filter(continent == x) %>%
                    ggplot(aes(x = card.death, y = totdeaths.mil)) +
                        geom_point(color = "#333aff") +
                        geom_smooth(color = "red") +
                        geom_smooth(method = "lm", color = "purple") +
                        theme_bw() +
                        labs(x = "Cardiovascular Death", y = "Total COVID-19 Deaths per Million People") +
                        labs(title = paste0("COVID-19 Deaths per Million People in ", (continent = x), " vs. Cardiovascular Death"))
} 
for (i in c("North America", "Europe", "Asia", "Africa", "Oceania", "South America")) {
  print(deaths.card(i))
} #Loops function for continents of interest. 
```

## Geospatial Analysis
### Downloading World Map File 
World map file is read in and prepared for overlaying with COVID-19 data.
```{r, eval = TRUE}
library(sf)
#File downloaded from https://hub.arcgis.com/datasets/esri::world-countries-generalized-1/explore and moved to working directory. 
world.map.zip <- "/Users/alanaschreibman/NO2_COVID-19.zip"
if (file.exists("World_Countries_.zip")) file.remove("World_Countries_.zip")
world.sf <- st_read("country_gen_trim.shp")  # Read shapefile as an sf object
class(world.sf)
head(world.sf)
world.geo <- st_geometry(world.sf)
plot(world.geo)
plot(world.geo, col = "lemonchiffon2")
plot(world.geo, lwd = 0.5, border = "red")
```

### Geospatial Distribution of COVID-19 Cases
Joins OWID data set with world map data frame and then use country cases to shade countries accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
library(RColorBrewer)
library(viridis)

my_theme <- function() {
  theme_minimal() +                                  
  theme(axis.line = element_blank(),
  plot.title  = element_text(size=30),
  axis.text = element_blank(),                 
  axis.title = element_blank(),
  panel.grid = element_line(color = "white"),  
  legend.key.size = unit(0.8, "cm"),          
  legend.text = element_text(size = 20),      
  legend.title = element_text(size = 20))
}

myPalette <- colorRampPalette(brewer.pal(9, "BuPu")) 

world.sf[105, "NAME"] <- "Democratic Republic of Congo"
world.sf <- world.sf %>%
  rename(location = NAME) %>% 
  inner_join(owid.countries, world.sf, by = "location") #Joined OWID data set with .sph file for geospatial analysis.  
ggplot(data = world.sf, aes(fill = totcases.mil),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Population-Adjusted Distribution of COVID-19 Cases") +
  scale_fill_gradientn(name = "COVID-19 \ncases (per million)",  
                    limits = c(0, 6500), 
                    colours = myPalette(100)) #Plot of world distribution of COVID-19 cases with color shading. 
```

### Geospatial Distribution of COVID-19 Deaths
Uses merged data frame and shades deaths by country accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
ggplot(data = world.sf, aes(fill = totdeaths.mil),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Population-Adjusted Distribution of COVID-19 Deaths") +
  scale_fill_gradientn(name = "COVID-19 \ndeaths (per million)",  
                    limits = c(0, 700), 
                    colours = myPalette(100)) #Plot of world distribution of COVID-19 deaths with color shading. 
```

### Geospatial Distribution of GDP per Capita
Uses merged data frame and shades GDP per capita by country accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
ggplot(data = world.sf, aes(fill = gdp.cap),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Global Distribution of GDP per Capita") +
  scale_fill_gradientn(name = "GDP \nper capita",  
                    limits = c(0, 60000), 
                    colours = myPalette(100)) 
```

### Geospatial Distribution of Population Density
Uses merged data frame and shades population density by country accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
ggplot(data = world.sf, aes(fill = pop.density),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Global Distribution of Population Density") +
  scale_fill_gradientn(name = "Population \ndensity",  
                    limits = c(0, 450), 
                    colours = myPalette(100)) #Plot of world distribution of COVID-19 deaths with color shading. 
```

### Geospatial Distribution of Median Age
Uses merged data frame and shades median age by country accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
ggplot(data = world.sf, aes(fill = med.age),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Global Distribution of Median Age") +
  scale_fill_gradientn(name = "Median \n age",  
                    limits = c(0, 50), 
                    colours = myPalette(100)) 
```

### Geospatial Distribution of Smoking
Uses merged data frame and shades male and female smoking percentages by country accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
ggplot(data = world.sf, aes(fill = fem.smokers),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Percentage of Female Smokers by Country") +
  scale_fill_gradientn(name = "Female \nsmokers (%)",  
                    limits = c(0, 40), 
                    colours = myPalette(100)) 

ggplot(data = world.sf, aes(fill = male.smokers),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Percentage of Male Smokers by Country") +
  scale_fill_gradientn(name = "Male \nsmokers (%)",  
                    limits = c(0, 80), 
                    colours = myPalette(100)) 
```

### Geospatial Distribution of Diabetes
Uses merged data frame and shades diabetes prevalence by country accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
ggplot(data = world.sf, aes(fill = diab.prev),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Diabetes Prevalence by Country") +
  scale_fill_gradientn(name = "Diabetes \nprevalence (%)",  
                    limits = c(0, 20), 
                    colours = myPalette(100)) 
```

### Geospatial Distribution of Cardiovascular Death
Uses merged data frame and shades indicence of cardiovascular death by country accordingly.
```{r, eval = TRUE, fig.width = 35, fig.height = 25}
ggplot(data = world.sf, aes(fill = card.death),
    lwd = 0.05) +
  geom_sf() +
  my_theme() +
  labs(title = "Incidence of Cardiovascular Death by Country") +
  scale_fill_gradientn(name = "Diabetes \nprevalence (%)",  
                    limits = c(0, 800), 
                    colours = myPalette(100)) 
```